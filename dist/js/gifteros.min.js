// Date and time functions
var today = new Date();
var hours = ("0" + today.getHours()).slice(-2);
var date = ("0" + today.getDate()).slice(-2);
var mnth = ("0" + today.getMonth()).slice(-2);
var year = today.getFullYear();
var day = new Array();
day[0] = 'Sunday';
day[1] = 'Monday';
day[2] = 'Tuesday';
day[3] = 'Wednesday';
day[4] = 'Thursday';
day[5] = 'Friday';
day[6] = 'Saturday';

var d = day[today.getDay()];

var month = new Array();
month[0] = 'January';
month[1] = 'February';
month[2] = 'March';
month[3] = 'April';
month[4] = 'May';
month[5] = 'June';
month[6] = 'July';
month[7] = 'August';
month[8] = 'September';
month[9] = 'October';
month[10] = 'November';
month[11] = 'December';

// Owl Carousel navigation icons
const prevIcon = '<img src="dist/images/app/circled-previous.svg" class="prev-icon" alt="Prev" height="40" width="40">';
const nextIcon = '<img src="dist/images/app/circled-next.svg" class="next-icon" alt="Next" height="40" width="40">';

// Alert messages
var message = '';

// Array of acceptible files
var acceptible_files = ['gif', 'jfif', 'png', 'jpg', 'jpeg'];


// Cart details
var gift_id, post_id, user_id, gift_name;
var gift_quantity = 1;
var gift_ids = [];

$(function() {
    // Enable popovers and tooltips
    $('[data-bs-toggle="popover"]').popover();
    $('[data-bs-toggle="tooltip"]').tooltip();

    // Hide the progress gradient when page is fully loaded
    $('.line').hide();

    //Alert Tone
    function alert_tone() {
        var tone = '<audio autoplay="true"><source src="../tones/alert.wav"></audio>';
        $('body').append(tone);
    }

    // Toggle scroll to top button
    $(window).on('scroll', function() {
        if ($(this).scrollTop() - 200 > 0) {
            // Show button
            $('.to-top').stop().addClass('show');
        } else {
            // Hide button
            $('.to-top').stop().removeClass('show');
        }
    });

    // Click to toggle floating-action-buttons
    $(document).on('click', '.toggle-actions', function() {
        $('.action-btn').toggleClass('show');
    });

    // Force numeric values on text inputs
    $('body').on('keyup', '.number-input', forceNumeric);

    // Gift search suggestions
    $(document).on('keyup', '#search', function() {
        let search = $(this).val();
        let val = search.length;
        if (val > 0) {
            $(this).addClass('expanded');
            $('.search-list').removeClass('d-none');
            $.ajax({
                url: '/search',
                method: 'get',
                data: {
                    search: search
                },
                dataType: 'json',
                success: function(data) {
                    $('.search-list').html(data.results);
                    userCurrency();
                }
            });
        } else {
            $(this).removeClass('expanded');
            $('.line').css('display', 'none');
            $('.search-list').addClass('d-none');
        }
    });

    // Close the search list if not in focus
    $(document).on('mouseup', function(e) {
        var search_list = $('.search-list');
        if (!search_list.is(e.target) && search_list.has(e.target).length == 0) {
            $('.search-list').addClass('d-none');
            $('#search-form')[0].reset();
            $('#search').removeClass('expanded');
        }
    });

    // Fetch all the forms we want to apply custom Bootstrap validation styles to
    var forms = document.getElementsByClassName('needs-validation');
    // Loop over them and prevent submission
    var validation = Array.prototype.filter.call(forms, function(form) {
        form.addEventListener('submit', function(event) {
            if (form.checkValidity() === false) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    //Get the button
    $(window).on('scroll', function() {
        if ($(document).height() >= $(window).height()) {
            $('#scroll-top').css('display', 'block');
        } else {
            $('#scroll-top').css('display', 'none');
        }
    });

    // Toggle the active class on the nav-icon
    $(document).on('click', function(e) {
        var icon_links = $('.icon-link');
        if (!icon_links.is(e.target) && icon_links.has(e.target).length == 0) {
            icon_links.removeClass('active');
        }
    });

    // Show the mega-menu on mouse-enter
    $('.mega-item').on('mouseenter', function(e) {
        $('.mega-menu').addClass('show');
    });

    // Hide the mega-menu on mouse-leave
    $('.mega-menu').on('mouseleave', function(e) {
        $('.mega-menu').removeClass('show');
    });

    // Choose currency
    $('.currency-option').on('click', function() {
        var currency_flag = $(this).children(':first').attr('src');
        var currency = $(this).children(':last').attr('id');
        var total = $(this).children(':last').data('total')
        $('#currency-flag').attr('src', currency_flag);
        $('#currency-total').html(total);
    });

    /*** App's Methods & Functions ***/
    /*** /.App's Methods & Functions ***/

    /*** Owl Carousel ***/
    // Main carousel
    $('.main-carousel').owlCarousel({
        loop: true,
        margin: 10,
        autoplay: true,
        smartSpeed: 450,
        autoplayHoverPause: true,
        responsive: {
            0: {
                items: 1
            },
            600: {
                items: 1
            },
            1000: {
                items: 1
            }
        }
    });
    // Gift Caterories Carousel
    $('.carousel-autoplay').owlCarousel({
        stagePadding: 50,
        loop: false,
        margin: 10,
        navRewind: false,
        stagePadding: true,
        smartSpeed: 450,
        lazyLoad: true,
        autoplayHoverPause: true,
        autoplay: true,
        nav: true,
        navText: [
            prevIcon,
            nextIcon
        ],
        dots: false,
        responsive: {
            0: {
                items: 1
            },
            320: {
                items: 2
            },
            576: {
                items: 2
            },
            768: {
                items: 3
            },
            992: {
                items: 4
            },
            1024: {
                items: 4
            },
            1200: {
                items: 7
            }
        }
    });
    /*** /.Owl Carousel ***/

    /*** Lazy load images ***/
    var lazyLoadImages;
    if ('IntersectionObserver' in window) {
        lazyLoadImages = document.querySelectorAll('.lazy');
        var imageObserver = new IntersectionObserver(function(entries, observer) {
            entries.forEach(function(entry) {
                if (entry.isIntersecting) {
                    var image = entry.target;
                    image.src = image.dataset.src;
                    image.classList.remove('lazy');
                    imageObserver.unobserve(image);
                }
            });
        });
        lazyLoadImages.forEach(function(image) {
            imageObserver.observe(image);
        });
    } else {
        var lazyLoadThrottleTimeout;
        lazyLoadImages = document.querySelectorAll('.lazy');

        function lazyLoading() {
            if (lazyLoadThrottleTimeout) {
                clearTimeout(lazyLoadThrottleTimeout);
            }
            lazyLoadThrottleTimeout = setTimeout(() => {
                var scrollTop = window.pageYOffset;
                lazyLoadImages.forEach(function(img) {
                    if (img.offsetTop < window.innerHeight + scrollTop) {
                        img.src = img.dataset.src;
                        img.classList.remove('lazy');
                    }
                });
                if (lazyLoadImages.length == 0) {
                    document.removeEventListener('scroll', lazyLoading);
                    window.removeEventListener('resize', lazyLoading);
                    window.removeEventListener('orientationChange', lazyLoading);
                }
            }, 20);
        }
        document.addEventListener('scroll', lazyLoading);
        window.addEventListener('resize', lazyLoading);
        window.addEventListener('orientationChange', lazyLoading);
    }
    /*** /.Lazy load images ***/
});


/*** App Updates ***/
// User greeting
(function greeting() {
    var greeting, icon;
    if (hours < 12) {
        greeting = "Good morning!";
        icon = "sunrise";
    } else if (hours < 18) {
        greeting = 'Good afternoon!';
        icon = "noon";
    } else {
        greeting = "Good evening!"
        icon = "cloudy-night";
    }
    $('.user-greeting').html(greeting);
    $('.greeting-icon').attr('src', "dist/images/greeting-icons/" + icon + ".svg");
})();
/*** /.App Updates ***/

// Force numeric
function forceNumeric() {
    var input = $(this);
    input.val(input.val().replace(/[^\d+(\.\d{1,2})?$]+/, ''));
}

/*** Alerts ***/
// General info alert
function infoAlert(message) {
    iziToast.show({
        theme: 'dark',
        timeout: 5000,
        closeOnClick: true,
        close: false,
        progressBar: false,
        backgroundColor: 'var(--dark-blue)',
        icon: 'bi bi-info-circle text-white-inverse',
        message: message,
        messageColor: 'var(--white-inverse)',
        position: 'topCenter'
    });
}

// Sweetalert2 success
function swalSuccess(message) {
    Swal.fire(
        '',
        message,
        'success',
    );
}

// General success alert message
function successAlert(message) {
    iziToast.show({
        theme: 'dark',
        timeout: 2000,
        closeOnClick: true,
        overlay: false,
        close: false,
        backgroundColor: 'var(--success)',
        progressBar: false,
        icon: 'bi bi-check2-circle text-light',
        message: message,
        messageColor: '#fff',
        position: 'topCenter'
    });
}

// Success alert message with gift image
function giftSuccessAlert(gift_image, message) {
    iziToast.show({
        animateInside: true,
        theme: 'dark',
        timeout: 3000,
        closeOnClick: true,
        overlay: false,
        close: false,
        backgroundColor: 'var(--success)',
        progressBar: false,
        icon: 'bi bi-check2-circle text-light',
        image: '/storage/gifts/' + gift_image,
        imageWidth: 60,
        message: message,
        messageColor: '#fff',
        position: 'topCenter'
    });
}

// General warning alert
function warningAlert(message) {
    iziToast.warning({
        theme: 'dark',
        timeout: 5000,
        closeOnClick: true,
        close: false,
        progressBar: false,
        backgroundColor: 'var(--warning)',
        icon: 'bi bi-exclamation-circle text-dark',
        message: message,
        messageColor: '#000',
        position: 'topCenter'
    });
}
/*** /.Alerts ***/